(function(e){"use strict";var t=t||{};t.App=Backbone.Router.extend({el:"#lift-status-page",initialize:function(){Backbone.emulateHTTP=true;Backbone.emulateJSON=true;this.settings=new t.SettingsCollection;this.domains=new t.DomainsCollection;this.on("resetLift",this.render,this).on("unsetDomainName",this.render,this);this.settings.on("sync reset",function(){var e=this.settings.getValue("credentials");this.domains.settings=this.settings;if(""===e.accessKey&&""===e.secretKey){this.domains.disablePolling()}else{this.domains.enablePolling()}this.render()},this).fetch();this.domains.on("sync_error",this.handleDomainSyncError,this)},render:function(){var e=this.getState();if(e){this.renderState(e)}return this},getState:function(){var n=this,r,i,s,o,u;u=this.settings.getValue("credentials");if(!(u.accessKey&&u.secretKey)){i="set_credentials"}else{if(typeof this.domains.deferred==="object"&&"then"in this.domains.deferred){e.when(this.domains.deferred).then(function(){n.render()})}else{s=this.settings.getValue("domainname");o=s&&this.domains.get(s);if(!s){i="set_domainname"}else if(o&&!(o.get("DocService")&&o.get("DocService").Endpoint)){i="processing_setup"}else{if(!o){r=new t.ModalMissingDomain({model:{settings:this.settings,domains:this.domains}});this.openModal(r)}i="dashboard"}}}return i},renderState:function(n){var r,i;i={set_credentials:{view:t.SetCredentialsView,args:{model:{settings:this.settings}}},set_domainname:{view:t.SetDomainView,args:{model:{settings:this.settings,domains:this.domains}}},processing_setup:{view:t.SetupProcessingView,args:{model:{settings:this.settings,domains:this.domains}}},dashboard:{view:t.DashboardView,args:{model:{settings:this.settings,domains:this.domains}}}};r=i[n];if(this.currentView&&this.currentView instanceof r.view){return}if(this.currentView){this.currentView.close()}this.currentView=new r.view(r.args);this.currentView.setElement(e("<div></div>").appendTo(this.el));this.currentView.render();return this},handleDomainSyncError:function(e,n){var r;if(n.code==="invalidCredentials"){r=new t.ModalErrorSetCredentialsView({model:{settings:this.settings}})}else{r=new t.ModalError({model:{settings:this.settings,domains:this.domains,error:n}})}if(r){this.openModal(r)}return this},openModal:function(t){var n=e("<div></div>");if(this.currentModal){this.closeModal(this.currentModal)}e("#modal_content").append(n);t.setElement(n);t.render();e("#lift_modal").show();this.currentModal=t;return this},closeModal:function(t){t.close();e("#modal_content").html("");e("#lift_modal").hide();delete this.currentModal;return this},resetLift:function(e){var t,n;e=e?_.clone(e):{};t=e.success;n=e.silent;e.silent=true;e.success=function(e,t){var r=e,i;t=t?_.clone(t):{};t.success=function(){if(i){i(r,t)}if(!n){r.trigger("resetLift",r,t)}};r.settings.get("credentials").save({value:{accessKey:"",secretKey:""}},t);r.domains.disablePolling();return this};this.unsetDomainName(e)},unsetDomainName:function(e){var t=this,n;e=e?_.clone(e):{};n=e.success;e.success=function(){if(n){n(t,e)}if(!e.silent){t.trigger("unsetDomainName",t,e)}};this.settings.get("domainname").save({value:""},e);return this}});t.templateLoader={templates:{},getTemplate:function(e){return this.templates[e]||this.loadTemplate(e)},loadTemplate:function(n){var r=window.liftData.templateDir+n+".html";e.ajax({url:r,type:"get",dataType:"html",async:false,success:function(e){t.templateLoader.templates[n]=e}});return this.templates[n]||false}};t.SettingModel=Backbone.Model.extend({url:function(){return window.ajaxurl+"?action=lift_setting&setting="+this.get("id")+"&nonce="+this.collection.getValue("nonce")},parse:function(e){if(e.id){return e}return e.data||null}});t.SettingsCollection=Backbone.Collection.extend({model:t.SettingModel,url:function(){return window.ajaxurl+"?action=lift_settings"},getValue:function(e){return this.get(e)&&this.get(e).get("value")},setValue:function(e,t){return this.get(e)&&this.get(e).set("value",t)},toJSONObject:function(){return _.object(this.map(function(e){return[e.get("id"),e.get("value")]}))}});t.UpdateQueue=Backbone.Collection.extend({initialize:function(){this.meta={page:1};this.disablePolling()},enablePolling:function(){if(!this.pollingEnabled){this.fetchWithDeferred()}this.pollingEnabled=true;return this},disablePolling:function(){if(this.pollingEnabled){clearTimeout(this.pollingTimeout)}this.pollingEnabled=false;return this},fetchWithDeferred:function(){var e=this,t=function(){e.fetchWithDeferred()};this.deferred=this.fetch().always(function(){delete e.deferred;if(e.pollingEnabled){e.pollingTimeout=setTimeout(t,6e4)}if(e.error&&e.pollingEnabled){e.trigger("sync_error",this,e.error)}});return this.deferred},url:function(){return window.ajaxurl+"?action=lift_update_queue&paged="+this.meta.page},fetchPage:function(e){this.meta.page=e;return this.fetch()},parse:function(e){this.meta.page=e.current_page;this.meta.per_page=e.per_page;this.meta.found_rows=e.found_rows;this.meta.total_pages=Math.ceil(e.found_rows/e.per_page);return e.updates},getMeta:function(e){return this.meta[e]}});t.UpdateQueueView=Backbone.View.extend({_template:"update-queue",initialize:function(){this.template=_.template(t.templateLoader.getTemplate(this._template));this.collection=new t.UpdateQueue;this.collection.on("sync",this.render,this).enablePolling()},events:{"click a.page-numbers":"onClickGoToPage"},render:function(){var t=this;if(typeof this.collection.deferred==="object"&&"then"in this.collection.deferred){e.when(this.collection.deferred).then(function(){t.render();return})}e(this.el).html(this.template({updates:this.collection.toJSON(),meta:this.collection.meta}));e("#lift_queue_nav").liftPaginator({totalPages:this.collection.getMeta("total_pages"),currentPage:this.collection.getMeta("page")});return this},onClickGoToPage:function(t){var n=e(t.target).attr("href").replace(/\D/g,"");t.preventDefault();this.goToPage(n)},goToPage:function(e){this.collection.fetchPage(e)}});t.ErrorLog=Backbone.Collection.extend({initialize:function(){this.meta={};this.disablePolling()},enablePolling:function(){if(!this.pollingEnabled){this.fetchWithDeferred()}this.pollingEnabled=true;return this},disablePolling:function(){if(this.pollingEnabled){clearTimeout(this.pollingTimeout)}this.pollingEnabled=false;return this},fetchWithDeferred:function(){var e=this,t=function(){e.fetchWithDeferred()};this.deferred=this.fetch().always(function(){delete e.deferred;if(e.pollingEnabled){e.pollingTimeout=setTimeout(t,6e4)}if(e.error&&e.pollingEnabled){e.trigger("sync_error",this,e.error)}});return this.deferred},url:function(){return window.ajaxurl+"?action=lift_error_log&nonce="+this.meta.nonce},parse:function(e){this.meta.nonce=e.meta;this.meta.view_all_url=e.view_all_url;return e.errors}});t.ErrorLogView=Backbone.View.extend({_template:"error-logs",initialize:function(){this.isCollectionSynced=false;this.template=_.template(t.templateLoader.getTemplate(this._template));this.collection=new t.ErrorLog;this.collection.on("all",this.render,this).enablePolling()},events:{"click #clear-logs":"onClickClearLogs"},render:function(){var t=this;if(typeof this.collection.deferred==="object"&&"then"in this.collection.deferred){e.when(this.collection.deferred).then(function(){t.render();return})}e(this.el).html(this.template({errors:this.collection.toJSON(),meta:JSON.stringify(this.collection.meta)}));return this},onClickClearLogs:function(e){e.preventDefault()}});t.DashboardView=Backbone.View.extend({initialize:function(){this.updateView=new t.UpdateQueueView({el:e("#document_queue")});if(window.liftData.errorLoggingEnabled){this.errorView=new t.ErrorLogView({el:e("#error_log")})}this.template=_.template(t.templateLoader.getTemplate("dashboard"));this.model.domains.on("reset",this.render,this);this.model.settings.on("reset",this.render,this)},onClose:function(){this.model.domains.off("reset",this.render,this)},events:{"click #batch_interval_update":"updateBatchInterval","click #batch_sync_now":"setSyncNow","click #lift_reset":"resetLift","click #override_search":"setOverrideSearch","click #lift_update_keys":"updateKeys"},render:function(){this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),domain:this.model.domains.toJSON()});e("#batch_interval_unit").val(this.model.settings.getValue("batch_interval").unit);this.updateView.setElement(e("#document_queue")).render();if(this.errorView){this.errorView.setElement(e("#error_log")).render()}return this},updateBatchInterval:function(){var t=this,n={value:e("#batch_interval").val(),unit:e("#batch_interval_unit").val()};this.beforeSave();this.model.settings.get("batch_interval").save({value:n},{}).always(function(){t.afterSave()});return this},setSyncNow:function(){var e=this;this.beforeSave();this.model.settings.get("next_sync").save({value:Math.round((new Date).getTime()/1e3)},{}).always(function(){e.model.settings.fetch();e.afterSave()});return this},setOverrideSearch:function(e){var t=this;this.beforeSave();this.model.settings.get("override_search").save({value:e.target.checked},{}).always(function(){t.afterSave()});return this},updateKeys:function(){var e=new t.ModalSetCredentialsView({model:{settings:this.model.settings}});n.openModal(e);return this},beforeSave:function(){e(this.el).find("input").attr("disabled",true);return this},afterSave:function(){e(this.el).find("input").attr("disabled",false);return this},resetLift:function(){n.resetLift();return this}});t.DomainModel=Backbone.Model.extend({url:function(){return window.ajaxurl+"?action=lift_domain&nonce="+this.getNonce()},idAttribute:"DomainName",getNonce:function(){return this.collection&&this.collection.nonce||this.nonce}});t.DomainsCollection=Backbone.Collection.extend({model:t.DomainModel,initialize:function(){this.disablePolling()},enablePolling:function(){if(!this.pollingEnabled){this.fetchWithDeferred()}this.pollingEnabled=true;return this},disablePolling:function(){if(this.pollingEnabled){clearTimeout(this.pollingTimeout)}this.pollingEnabled=false;return this},fetchWithDeferred:function(){var e=this,t=function(){e.fetchWithDeferred()};var n=this.settings.get("region").get("value");this.deferred=this.fetch({data:{region:n}}).always(function(){delete e.deferred;if(e.pollingEnabled){e.pollingTimeout=setTimeout(t,6e4)}if(e.error&&e.pollingEnabled){e.trigger("sync_error",this,e.error)}});return this.deferred},url:function(){return window.ajaxurl+"?action=lift_domains"},parse:function(e){this.nonce=e.nonce;this.error=e.error;return e.domains}});Backbone.View.prototype.close=function(){this.remove();this.unbind();this.undelegateEvents();if(this.onClose){this.onClose()}};t.SetCredentialsView=Backbone.View.extend({_template:"set-credentials",loadText:e('<p id="lift-load-text">'),loader:e('<p id="lift-ajax-loader">'),initialize:function(){this.template=_.template(t.templateLoader.getTemplate(this._template));this.model.settings.get("credentials").on("error",this.onSaveError,this);this.model.settings.get("credentials").on("sync",this.onSaveSuccess,this)},onClose:function(){this.model.settings.get("credentials").off("error",this.onSaveError,this);this.model.settings.get("credentials").off("sync",this.onSaveSuccess,this)},events:{"click #save_credentials":"updateCredentials"},render:function(){this.el.innerHTML=this.template(this.model.settings.toJSONObject());e("#save_credentials").after(this.loader);return this},ajaxLoader:function(e){this.loadText.text(e);this.loader.html(this.loadText);this.loader.show()},beforeSave:function(){e("#errors").hide();e("#save_credentials").attr("disabled","disabled");this.ajaxLoader("Authenticating with Amazon")},updateCredentials:function(){var t=this,n={accessKey:e("#accessKey").val(),secretKey:e("#secretKey").val()};this.beforeSave();this.model.settings.get("credentials").save({value:n},{})},onSaveError:function(t,n){var r=e.parseJSON(n.responseText).errors;this.renderErrors(r);e("#save_credentials").removeAttr("disabled");this.loader.hide();return this},onSaveSuccess:function(){this.ajaxLoader("Saving")},renderErrors:function(n){var r=t.templateLoader.getTemplate("errors");e("#errors").html(_.template(r,{errors:n})).show();return this}});t.ModalSetCredentialsView=t.SetCredentialsView.extend({_template:"modal-set-credentials",initialize:function(){this.template=_.template(t.templateLoader.getTemplate(this._template));this.model.settings.get("credentials").on("sync",this.closeModal,this)},events:{"click #cancel":"closeModal","click #save_credentials":"updateCredentials"},onClose:function(){this.model.settings.get("credentials").off("sync",this.closeModal,this)},closeModal:function(){n.closeModal(this)}});t.ModalErrorSetCredentialsView=t.SetCredentialsView.extend({_template:"modal-error-set-credentials"});t.ModalError=Backbone.View.extend({_template:"modal-error",initialize:function(){this.template=_.template(t.templateLoader.getTemplate(this._template));this.model.domains.on("reset",this.closeIfFixed,this)},render:function(){this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),error:this.model.error});return this},closeIfFixed:function(){if(!this.model.domains.error){n.closeModal(this)}return this}});t.ModalMissingDomain=Backbone.View.extend({_template:"modal-error-missing-domain",initialize:function(){this.template=_.template(t.templateLoader.getTemplate(this._template))},events:{"click #reset_lift":"resetLift","click #unset_domainname":"unsetDomainName"},render:function(){this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),error:this.model.error});return this},resetLift:function(){n.on("resetLift",this.closeModal,this).resetLift();return this},unsetDomainName:function(){n.on("unsetDomainName",this.closeModal,this).unsetDomainName();return this},closeModal:function(){n.closeModal(this)}});t.SetDomainView=Backbone.View.extend({loadText:e('<p id="lift-load-text">'),loader:e('<p id="lift-ajax-loader">'),initialize:function(){this.template=_.template(t.templateLoader.getTemplate("set-domain"))},events:{"click #save_domainname":"setDomainname","click #cancel":"goBack","keypress #domainname":"submitOnEnter"},ajaxLoader:function(e){this.loadText.text(e);this.loader.html(this.loadText);this.loader.show()},render:function(){this.el.innerHTML=this.template(this.model.settings.toJSONObject());e("#save_domainname").after(this.loader);return this},beforeSave:function(){e("#errors").hide();e("#save_domainname").attr("disabled","disabled");return this},afterSave:function(){e("#save_domainname").removeAttr("disabled");return this},submitOnEnter:function(e){if(13!=e.keyCode)return;e.preventDefault();document.getElementById("save_domainname").click();return this},setDomainname:function(){var t,n,r;this.beforeSave();t=e("#domainname").val();r=e("#region").val();n=this.model.domains.get(t);if(!n){this.createDomain(t,r)}else{var i=this.model.domains.get(t);this.showConfirmModal(i)}return this},showConfirmModal:function(e){var r=new t.ModalConfirmDomainView({model:e});r.on("cancelled",this.modalCancelled,this);r.on("confirmed",this.modalConfirmed,this);n.openModal(r)},modalCancelled:function(t){e("#save_domainname").removeAttr("disabled");n.closeModal(t);return this},modalConfirmed:function(e,t){n.closeModal(e);this.useDomain(t);return this},createDomain:function(e,n){var r;this.ajaxLoader("Creating Domain");r=new t.DomainModel({DomainName:e,Region:n});r.nonce=this.model.domains.nonce;r.on("sync",this.onCreateDomainSuccess,this);r.on("error",this.onCreateDomainError,this);r.save();return this},onCreateDomainSuccess:function(e,n){var r=this;this.ajaxLoader("Saving");e.off("sync",this.onCreateDomainSuccess,this);e.off("error",this.onCreateDomainError,this);if(n.data){var i=new t.DomainModel(n.data);this.model.domains.add(i);this.useDomain(i)}else{this.ajaxLoader("Waiting for Amazon to initialize domain");this.model.domains.on("sync",function(){i=this.model.domains.get(e);if(i){r.useDomain(i)}},this);this.model.domains.enablePolling()}},onCreateDomainError:function(t,n){var r=e.parseJSON(n.responseText).errors;this.loader.hide();t.off("sync",this.onCreateDomainSuccess,this);t.off("error",this.onCreateDomainError,this);if(r[0].code==="domain_exists"){this.model.domains.add(t);this.showConfirmModal(t)}else{this.renderErrors(r).afterSave()}},renderErrors:function(n){var r=t.templateLoader.getTemplate("errors");e("#errors").html(_.template(r,{errors:n})).show();return this},goBack:function(){n.renderState("set_credentials");return this},useDomain:function(t){n.settings.get("domainname").save({value:t.get("DomainName"),region:e("#region").val()});return this}});t.ModalConfirmDomainView=Backbone.View.extend({initialize:function(){this.template=_.template(t.templateLoader.getTemplate("modal-confirm-domain"))},events:{"click #confirm_domain":"confirm","click #cancel_domain":"cancel"},render:function(){this.el.innerHTML=this.template(this.model.toJSON());return this},confirm:function(){this.trigger("confirmed",this,this.model);return this},cancel:function(){this.trigger("cancelled",this,this.model);return this}});t.SetupProcessingView=Backbone.View.extend({initialize:function(){this.template=_.template(t.templateLoader.getTemplate("setup-processing"));this.model.domains.on("reset",this.render,this)},render:function(){var e=this.model.domains.get(this.model.settings.getValue("domainname")),r;if(e.get("Deleted")){r=new t.ModalMissingDomain({model:this.model});n.openModal(r)}if(!e||e.get("DocService").EndPoint){n.render();return this}this.el.innerHTML=this.template(e.toJSON());return this},onClose:function(){this.model.domains.off("reset",this.render,this);return this}});var n=new t.App})(jQuery,window);(function(e){e.fn.liftPaginator=function(t){var n,r;var i=function(e,t){if(e===t){return'<span class="page-numbers current">'+e+"</span>"}return'<a class="page-numbers" href="#'+e+'">'+e+"</a>"};n={totalPages:1,currentPage:1,midSize:1,endSize:2};r=e.extend(n,t);return this.each(function(){var t=e(this),n=[],s,o;if(r.totalPages>1){if(r.currentPage>1){n.push('<a class="next page-numbers" href="'+(r.currentPage-1)+'">« Previous</a></span>')}for(s=1,o=1+r.endSize;s<o;s+=1){n.push(i(s,r.currentPage))}if(s<r.currentPage-r.midSize){n.push('<span class="page-numbers dots">…</span>')}s=Math.max(s,r.currentPage-r.midSize);o=Math.min(r.currentPage+r.midSize+1,r.totalPages-r.endSize+1);if(s<o){for(;s<o;s+=1){n.push(i(s,r.currentPage))}}if(s<r.totalPages-r.endSize+1){n.push('<span class="page-numbers dots">…</span>')}s=Math.max(s,r.totalPages-r.endSize+1);for(;s<=r.totalPages;s+=1){n.push(i(s,r.currentPage))}if(r.currentPage<r.totalPages){n.push('<a class="next page-numbers" href="'+(r.currentPage+1)+'">Next »</a></span>')}t.append('<span class="pagination-links">'+n.join("")+"</span>")}})}})(jQuery)