!function(a){"use strict";var b=b||{};b.App=Backbone.Router.extend({el:"#lift-status-page",initialize:function(){Backbone.emulateHTTP=!0,Backbone.emulateJSON=!0,this.settings=new b.SettingsCollection,this.domains=new b.DomainsCollection,this.on("resetLift",this.render,this).on("unsetDomainName",this.render,this),this.settings.on("sync reset",function(){var a=this.settings.getValue("credentials");""===a.accessKey&&""===a.secretKey?this.domains.disablePolling():this.domains.enablePolling(),this.render()},this).fetch(),this.domains.on("sync_error",this.handleDomainSyncError,this)},render:function(){var a=this.getState();return a&&this.renderState(a),this},getState:function(){var d,e,f,g,h,c=this;return h=this.settings.getValue("credentials"),h.accessKey&&h.secretKey?"object"==typeof this.domains.deferred&&"then"in this.domains.deferred?a.when(this.domains.deferred).then(function(){c.render()}):(f=this.settings.getValue("domainname"),g=f&&this.domains.get(f),f?!g||g.get("DocService")&&g.get("DocService").Endpoint?(g||(d=new b.ModalMissingDomain({model:{settings:this.settings,domains:this.domains}}),this.openModal(d)),e="dashboard"):e="processing_setup":e="set_domainname"):e="set_credentials",e},renderState:function(c){var d,e;return e={set_credentials:{view:b.SetCredentialsView,args:{model:{settings:this.settings}}},set_domainname:{view:b.SetDomainView,args:{model:{settings:this.settings,domains:this.domains}}},processing_setup:{view:b.SetupProcessingView,args:{model:{settings:this.settings,domains:this.domains}}},dashboard:{view:b.DashboardView,args:{model:{settings:this.settings,domains:this.domains}}}},d=e[c],this.currentView&&this.currentView instanceof d.view?void 0:(this.currentView&&this.currentView.close(),this.currentView=new d.view(d.args),this.currentView.setElement(a("<div></div>").appendTo(this.el)),this.currentView.render(),this)},handleDomainSyncError:function(a,c){var d;return d="invalidCredentials"===c.code?new b.ModalErrorSetCredentialsView({model:{settings:this.settings}}):new b.ModalError({model:{settings:this.settings,domains:this.domains,error:c}}),d&&this.openModal(d),this},openModal:function(b){var c=a("<div></div>");return this.currentModal&&this.closeModal(this.currentModal),a("#modal_content").append(c),b.setElement(c),b.render(),a("#lift_modal").show(),this.currentModal=b,this},closeModal:function(b){return b.close(),a("#modal_content").html(""),a("#lift_modal").hide(),delete this.currentModal,this},resetLift:function(a){var b,c;a=a?_.clone(a):{},b=a.success,c=a.silent,a.silent=!0,a.success=function(a,b){var e,d=a;return b=b?_.clone(b):{},b.success=function(){e&&e(d,b),c||d.trigger("resetLift",d,b)},d.settings.get("credentials").save({value:{accessKey:"",secretKey:""}},b),d.domains.disablePolling(),this},this.unsetDomainName(a)},unsetDomainName:function(a){var c,b=this;return a=a?_.clone(a):{},c=a.success,a.success=function(){c&&c(b,a),a.silent||b.trigger("unsetDomainName",b,a)},this.settings.get("domainname").save({value:""},a),this}}),b.templateLoader={templates:{},getTemplate:function(a){return this.templates[a]||this.loadTemplate(a)},loadTemplate:function(c){var d=window.liftData.templateDir+c+".html";return a.ajax({url:d,type:"get",dataType:"html",async:!1,success:function(a){b.templateLoader.templates[c]=a}}),this.templates[c]||!1}},b.SettingModel=Backbone.Model.extend({url:function(){return window.ajaxurl+"?action=lift_setting&setting="+this.get("id")+"&nonce="+this.collection.getValue("nonce")},parse:function(a){return a.id?a:a.data||null}}),b.SettingsCollection=Backbone.Collection.extend({model:b.SettingModel,url:function(){return window.ajaxurl+"?action=lift_settings"},getValue:function(a){return this.get(a)&&this.get(a).get("value")},setValue:function(a,b){return this.get(a)&&this.get(a).set("value",b)},toJSONObject:function(){return _.object(this.map(function(a){return[a.get("id"),a.get("value")]}))}}),b.UpdateQueue=Backbone.Collection.extend({initialize:function(){this.meta={page:1},this.disablePolling()},enablePolling:function(){return this.pollingEnabled||this.fetchWithDeferred(),this.pollingEnabled=!0,this},disablePolling:function(){return this.pollingEnabled&&clearTimeout(this.pollingTimeout),this.pollingEnabled=!1,this},fetchWithDeferred:function(){var a=this,b=function(){a.fetchWithDeferred()};return this.deferred=this.fetch().always(function(){delete a.deferred,a.pollingEnabled&&(a.pollingTimeout=setTimeout(b,6e4)),a.error&&a.pollingEnabled&&a.trigger("sync_error",this,a.error)}),this.deferred},url:function(){return window.ajaxurl+"?action=lift_update_queue&paged="+this.meta.page},fetchPage:function(a){return this.meta.page=a,this.fetch()},parse:function(a){return this.meta.page=a.current_page,this.meta.per_page=a.per_page,this.meta.found_rows=a.found_rows,this.meta.total_pages=Math.ceil(a.found_rows/a.per_page),a.updates},getMeta:function(a){return this.meta[a]}}),b.UpdateQueueView=Backbone.View.extend({_template:"update-queue",initialize:function(){this.template=_.template(b.templateLoader.getTemplate(this._template)),this.collection=new b.UpdateQueue,this.collection.on("sync",this.render,this).enablePolling()},events:{"click a.page-numbers":"onClickGoToPage"},render:function(){var b=this;return"object"==typeof this.collection.deferred&&"then"in this.collection.deferred&&a.when(this.collection.deferred).then(function(){b.render()}),a(this.el).html(this.template({updates:this.collection.toJSON(),meta:this.collection.meta})),a("#lift_queue_nav").liftPaginator({totalPages:this.collection.getMeta("total_pages"),currentPage:this.collection.getMeta("page")}),this},onClickGoToPage:function(b){var c=a(b.target).attr("href").replace(/\D/g,"");b.preventDefault(),this.goToPage(c)},goToPage:function(a){this.collection.fetchPage(a)}}),b.ErrorLog=Backbone.Collection.extend({initialize:function(){this.meta={},this.disablePolling()},enablePolling:function(){return this.pollingEnabled||this.fetchWithDeferred(),this.pollingEnabled=!0,this},disablePolling:function(){return this.pollingEnabled&&clearTimeout(this.pollingTimeout),this.pollingEnabled=!1,this},fetchWithDeferred:function(){var a=this,b=function(){a.fetchWithDeferred()};return this.deferred=this.fetch().always(function(){delete a.deferred,a.pollingEnabled&&(a.pollingTimeout=setTimeout(b,6e4)),a.error&&a.pollingEnabled&&a.trigger("sync_error",this,a.error)}),this.deferred},url:function(){return window.ajaxurl+"?action=lift_error_log&nonce="+this.meta.nonce},parse:function(a){return this.meta.nonce=a.meta,this.meta.view_all_url=a.view_all_url,a.errors}}),b.ErrorLogView=Backbone.View.extend({_template:"error-logs",initialize:function(){this.isCollectionSynced=!1,this.template=_.template(b.templateLoader.getTemplate(this._template)),this.collection=new b.ErrorLog,this.collection.on("all",this.render,this).enablePolling()},events:{"click #clear-logs":"onClickClearLogs"},render:function(){var b=this;return"object"==typeof this.collection.deferred&&"then"in this.collection.deferred&&a.when(this.collection.deferred).then(function(){b.render()}),a(this.el).html(this.template({errors:this.collection.toJSON(),meta:JSON.stringify(this.collection.meta)})),this},onClickClearLogs:function(a){a.preventDefault()}}),b.DashboardView=Backbone.View.extend({initialize:function(){this.updateView=new b.UpdateQueueView({el:a("#document_queue")}),window.liftData.errorLoggingEnabled&&(this.errorView=new b.ErrorLogView({el:a("#error_log")})),this.template=_.template(b.templateLoader.getTemplate("dashboard")),this.model.domains.on("reset",this.render,this),this.model.settings.on("reset",this.render,this)},onClose:function(){this.model.domains.off("reset",this.render,this)},events:{"click #batch_interval_update":"updateBatchInterval","click #batch_sync_now":"setSyncNow","click #lift_reset":"resetLift","click #override_search":"setOverrideSearch","click #lift_update_keys":"updateKeys"},render:function(){return this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),domain:this.model.domains.toJSON()}),a("#batch_interval_unit").val(this.model.settings.getValue("batch_interval").unit),this.updateView.setElement(a("#document_queue")).render(),this.errorView&&this.errorView.setElement(a("#error_log")).render(),this},updateBatchInterval:function(){var b=this,c={value:a("#batch_interval").val(),unit:a("#batch_interval_unit").val()};return this.beforeSave(),this.model.settings.get("batch_interval").save({value:c},{}).always(function(){b.afterSave()}),this},setSyncNow:function(){var a=this;return this.beforeSave(),this.model.settings.get("next_sync").save({value:Math.round((new Date).getTime()/1e3)},{}).always(function(){a.model.settings.fetch(),a.afterSave()}),this},setOverrideSearch:function(a){var b=this;return this.beforeSave(),this.model.settings.get("override_search").save({value:a.target.checked},{}).always(function(){b.afterSave()}),this},updateKeys:function(){var a=new b.ModalSetCredentialsView({model:{settings:this.model.settings}});return c.openModal(a),this},beforeSave:function(){return a(this.el).find("input").attr("disabled",!0),this},afterSave:function(){return a(this.el).find("input").attr("disabled",!1),this},resetLift:function(){return c.resetLift(),this}}),b.DomainModel=Backbone.Model.extend({url:function(){return window.ajaxurl+"?action=lift_domain&nonce="+this.getNonce()},idAttribute:"DomainName",getNonce:function(){return this.collection&&this.collection.nonce||this.nonce}}),b.DomainsCollection=Backbone.Collection.extend({model:b.DomainModel,initialize:function(){this.disablePolling()},enablePolling:function(){return this.pollingEnabled||this.fetchWithDeferred(),this.pollingEnabled=!0,this},disablePolling:function(){return this.pollingEnabled&&clearTimeout(this.pollingTimeout),this.pollingEnabled=!1,this},fetchWithDeferred:function(){var a=this,b=function(){a.fetchWithDeferred()};return this.deferred=this.fetch().always(function(){delete a.deferred,a.pollingEnabled&&(a.pollingTimeout=setTimeout(b,6e4)),a.error&&a.pollingEnabled&&a.trigger("sync_error",this,a.error)}),this.deferred},url:function(){return window.ajaxurl+"?action=lift_domains"},parse:function(a){return this.nonce=a.nonce,this.error=a.error,a.domains}}),Backbone.View.prototype.close=function(){this.remove(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},b.SetCredentialsView=Backbone.View.extend({_template:"set-credentials",initialize:function(){this.template=_.template(b.templateLoader.getTemplate(this._template)),this.model.settings.get("credentials").on("error",this.onSaveError,this)},onClose:function(){this.model.settings.get("credentials").off("error",this.onSaveError,this)},events:{"click #save_credentials":"updateCredentials"},render:function(){return this.el.innerHTML=this.template(this.model.settings.toJSONObject()),this},beforeSave:function(){a("#errors").hide(),a("#save_credentials").attr("disabled","disabled")},afterSave:function(){a("#save_credentials").removeAttr("disabled")},updateCredentials:function(){var b=this,c={accessKey:a("#accessKey").val(),secretKey:a("#secretKey").val()};this.beforeSave(),this.model.settings.get("credentials").save({value:c},{}).always(function(){b.afterSave()})},onSaveError:function(b,c){var d=a.parseJSON(c.responseText).errors;return this.renderErrors(d),this},renderErrors:function(c){var d=b.templateLoader.getTemplate("errors");return a("#errors").html(_.template(d,{errors:c})).show(),this}}),b.ModalSetCredentialsView=b.SetCredentialsView.extend({_template:"modal-set-credentials",initialize:function(){this.template=_.template(b.templateLoader.getTemplate(this._template)),this.model.settings.get("credentials").on("sync",this.closeModal,this)},events:{"click #cancel":"closeModal","click #save_credentials":"updateCredentials"},onClose:function(){this.model.settings.get("credentials").off("sync",this.closeModal,this)},closeModal:function(){c.closeModal(this)}}),b.ModalErrorSetCredentialsView=b.SetCredentialsView.extend({_template:"modal-error-set-credentials"}),b.ModalError=Backbone.View.extend({_template:"modal-error",initialize:function(){this.template=_.template(b.templateLoader.getTemplate(this._template)),this.model.domains.on("reset",this.closeIfFixed,this)},render:function(){return this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),error:this.model.error}),this},closeIfFixed:function(){return this.model.domains.error||c.closeModal(this),this}}),b.ModalMissingDomain=Backbone.View.extend({_template:"modal-error-missing-domain",initialize:function(){this.template=_.template(b.templateLoader.getTemplate(this._template))},events:{"click #reset_lift":"resetLift","click #unset_domainname":"unsetDomainName"},render:function(){return this.el.innerHTML=this.template({settings:this.model.settings.toJSONObject(),error:this.model.error}),this},resetLift:function(){return c.on("resetLift",this.closeModal,this).resetLift(),this},unsetDomainName:function(){return c.on("unsetDomainName",this.closeModal,this).unsetDomainName(),this},closeModal:function(){c.closeModal(this)}}),b.SetDomainView=Backbone.View.extend({initialize:function(){this.template=_.template(b.templateLoader.getTemplate("set-domain"))},events:{"click #save_domainname":"setDomainname","click #cancel":"goBack","keypress #domainname":"submitOnEnter"},render:function(){return this.el.innerHTML=this.template(this.model.settings.toJSONObject()),this},beforeSave:function(){return a("#errors").hide(),a("#save_domainname").attr("disabled","disabled"),this},afterSave:function(){return a("#save_domainname").removeAttr("disabled"),this},submitOnEnter:function(a){return 13==a.keyCode?(a.preventDefault(),document.getElementById("save_domainname").click(),this):void 0},setDomainname:function(){var d,e,f;return this.beforeSave(),d=a("#domainname").val(),e=this.model.domains.get(d),e?(f=new b.ModalConfirmDomainView({model:this.model.domains.get(d)}),f.on("cancelled",this.modalCancelled,this),f.on("confirmed",this.modalConfirmed,this),c.openModal(f)):this.createDomain(d),this},modalCancelled:function(b){return a("#save_domainname").removeAttr("disabled"),c.closeModal(b),this},modalConfirmed:function(a,b){return c.closeModal(a),this.useDomain(b),this},createDomain:function(a){var c;return c=new b.DomainModel({DomainName:a}),c.nonce=this.model.domains.nonce,c.on("sync",this.onCreateDomainSuccess,this),c.on("error",this.onCreateDomainError,this),c.save(),this},onCreateDomainSuccess:function(a,c){var d=new b.DomainModel(c.data);a.off("sync",this.onCreateDomainSuccess,this),a.off("error",this.onCreateDomainError,this),this.model.domains.add(d),this.useDomain(d)},onCreateDomainError:function(b,c){var d=a.parseJSON(c.responseText).errors;b.off("sync",this.onCreateDomainSuccess,this),b.off("error",this.onCreateDomainError,this),this.renderErrors(d).afterSave()},renderErrors:function(c){var d=b.templateLoader.getTemplate("errors");return a("#errors").html(_.template(d,{errors:c})).show(),this},goBack:function(){return c.renderState("set_credentials"),this},useDomain:function(a){return c.settings.get("domainname").save({value:a.get("DomainName")}),this.afterSave(),this}}),b.ModalConfirmDomainView=Backbone.View.extend({initialize:function(){this.template=_.template(b.templateLoader.getTemplate("modal-confirm-domain"))},events:{"click #confirm_domain":"confirm","click #cancel_domain":"cancel"},render:function(){return this.el.innerHTML=this.template(this.model.toJSON()),this},confirm:function(){return this.trigger("confirmed",this,this.model),this},cancel:function(){return this.trigger("cancelled",this,this.model),this}}),b.SetupProcessingView=Backbone.View.extend({initialize:function(){this.template=_.template(b.templateLoader.getTemplate("setup-processing")),this.model.domains.on("reset",this.render,this)},render:function(){var d,a=this.model.domains.get(this.model.settings.getValue("domainname"));return a.get("Deleted")&&(d=new b.ModalMissingDomain({model:this.model}),c.openModal(d)),!a||a.get("DocService").EndPoint?(c.render(),this):(this.el.innerHTML=this.template(a.toJSON()),this)},onClose:function(){return this.model.domains.off("reset",this.render,this),this}});var c=new b.App}(jQuery,window),function(a){a.fn.liftPaginator=function(b){var c,d,e=function(a,b){return a===b?'<span class="page-numbers current">'+a+"</span>":'<a class="page-numbers" href="#'+a+'">'+a+"</a>"};return c={totalPages:1,currentPage:1,midSize:1,endSize:2},d=a.extend(c,b),this.each(function(){var f,g,b=a(this),c=[];if(d.totalPages>1){for(d.currentPage>1&&c.push('<a class="next page-numbers" href="'+(d.currentPage-1)+'">&laquo; Previous</a></span>'),f=1,g=1+d.endSize;g>f;f+=1)c.push(e(f,d.currentPage));if(f<d.currentPage-d.midSize&&c.push('<span class="page-numbers dots">\u2026</span>'),f=Math.max(f,d.currentPage-d.midSize),g=Math.min(d.currentPage+d.midSize+1,d.totalPages-d.endSize+1),g>f)for(;g>f;f+=1)c.push(e(f,d.currentPage));for(f<d.totalPages-d.endSize+1&&c.push('<span class="page-numbers dots">\u2026</span>'),f=Math.max(f,d.totalPages-d.endSize+1);f<=d.totalPages;f+=1)c.push(e(f,d.currentPage));d.currentPage<d.totalPages&&c.push('<a class="next page-numbers" href="'+(d.currentPage+1)+'">Next &raquo;</a></span>'),b.append('<span class="pagination-links">'+c.join("")+"</span>")}})}}(jQuery);